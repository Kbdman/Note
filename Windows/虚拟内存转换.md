# 虚拟地址转换

## 分级页表
分级页表总的来说就是分割虚拟地址空间，将地址高位的几个部份作为索引查表最终得到所需的页表。      
分级页表的好处在于节省内存空间，如果一个高层索引对应的地址空间内没有reserve地址，则不需要位它们创建页表     
为什么使用X级页表，一方面可能是节约内存，另一方面可能是收到CPU的MMU的制约       

### 32位Windows的分级页表结构
32位的Windows采用三级页表
CR3保存着当前进程的PDPT指针
+ PDPT      
PageDirectoryPointTable 页目录指针表，保存着4个页目录的物理地址
+ PD        
页目录，每个页目录保存着512个PDE(Page Directory Entry),分别指向512个页表的物理地址
+ PT
页表，每个页表保存着512个PTE(Page Tabel Entry),指向各个页的物理地址

### 64位Window的分级页表结构
CR3保存着当前进程的PageMap地址
+ Page Map      
保存着512个PDPT的物理地址
+ PDPT
512个PD的指针
+ PD
+ PT

这些表都是通过表项中的PFN来索引具体的物理页

## TLB
Translation Look-aside buffer       
由于每次虚拟地址到物理地址的转换都要经过多次步骤访问内存，效率较低。
Windows将近期进行过地址转换的页与对应的物理页的对应关系保存在一个缓存中，每次进行地址转换时都优先从缓存中找最近是否由进行过该页的地址转换

## VAD
虚拟地址描述符      
对于每一个进程，系统都维护一组VAD,用于描述描述的虚拟地址空间的状态。        
VAD被组织成一个自平衡二叉树,保存在非分页内存上
当一个进程预留一段地址或者映射表一个View时，内存管理器为它们创建VAD     
只有当一个地址所在页第一次被访问时，内存管理器才为这个页创建一个PTE     
?虚拟地址转换的过程到底时如何？
查询TLB，不存在查PT，查不到查VAD，还是查询TLB，不存在查VAD，如果时以Commit的内存创建页表项，然后再查PT呢？